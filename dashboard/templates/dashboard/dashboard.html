{% extends "dashboard/base.html" %}

{% block content %}
<h1>Dashboard</h1>

<!-- Formulario de filtro -->
<form method="get">
    <label for="agent">Agente:</label>
    <select name="agent" id="agent">
        <option value="">--Todos--</option>
        {% for agent in agents %}
            <option value="{{ agent }}" {% if selected_agent == agent %}selected{% endif %}>{{ agent }}</option>
        {% endfor %}
    </select>

    <label for="team">Equipo:</label>
    <select name="team" id="team">
        <option value="">--Todos--</option>
        {% for team in teams %}
            <option value="{{ team }}" {% if selected_team == team %}selected{% endif %}>{{ team }}</option>
        {% endfor %}
    </select>

    <br>
    <label for="week_start">Inicio de la semana:</label>
    <input type="date" name="week_start" id="week_start" value="{{ week_start }}">
    <label for="week_end">Fin de la semana:</label>
    <input type="date" name="week_end" id="week_end" value="{{ week_end }}">
    <br>
    <button type="submit">Filtrar</button>
</form>

<br>
<!-- Botón de descarga de PDF para el dashboard -->
<a href="{% url 'download_dashboard_pdf' %}?agent={{ selected_agent|default:'' }}&team={{ selected_team|default:'' }}&week_start={{ week_start|default:'' }}&week_end={{ week_end|default:'' }}"
   style="display: inline-block; background: #333; color: #fff; padding: 10px 15px; text-decoration: none; border-radius: 4px;">
   Descargar PDF
</a>

<br><br>
<!-- Contenedor para los gráficos -->
<div class="chart-row" style="display: flex; flex-wrap: wrap; gap: 20px;">
    <!-- Gráfica de AHT - segmento general (más pequeña) -->
    <div class="chart-item" style="flex: 1 1 300px; max-width: 45%;">
        <h3>AHT (seg) - General</h3>
        <canvas id="ahtChart" width="300" height="150"></canvas>
    </div>
    <!-- Gráfica de SL - segmento general (más pequeña) -->
    <div class="chart-item" style="flex: 1 1 300px; max-width: 45%;">
        <h3>SLA (%) - General</h3>
        <canvas id="slChart" width="300" height="150"></canvas>
    </div>
</div>

<br>
<!-- Gráfica de CSAT -->
<div class="chart-row" style="margin-top: 20px;">
    <div class="chart-item" style="width: 100%;">
        <h3>CSAT Promedio por Segmento</h3>
        <canvas id="csatChart" width="600" height="150"></canvas>
    </div>
</div>

<!-- Incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Gráfica de AHT para segmento general
    var ahtCtx = document.getElementById('ahtChart').getContext('2d');
    var ahtChart = new Chart(ahtCtx, {
        type: 'bar',
        data: {
            labels: ['AHT General'],
            datasets: [{
                label: 'AHT (seg)',
                data: [{{ aht_data|default:0 }}],
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Gráfica de SL para segmento general
    var slCtx = document.getElementById('slChart').getContext('2d');
    var slChart = new Chart(slCtx, {
        type: 'bar',
        data: {
            labels: ['SL General'],
            datasets: [{
                label: 'SL (%)',
                data: [{{ sl_data|default:0 }}],
                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Gráfica de CSAT por segmentos
    var csatCtx = document.getElementById('csatChart').getContext('2d');
    var csatChart = new Chart(csatCtx, {
        type: 'bar',
        data: {
            labels: ['Clientes', 'Repartidores', 'Restaurantes', 'General'],
            datasets: [{
                label: 'CSAT Promedio',
                data: [
                    {{ csat_clientes|default:0 }},
                    {{ csat_repartidores|default:0 }},
                    {{ csat_restaurantes|default:0 }},
                    {{ csat_general|default:0 }}
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
{% endblock %}
